---
title: "Top Days By Burned Area"
author: "Rui Almeida"
date: "`r Sys.Date()`"
output: ioslides_presentation
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(plotly)
library(lubridate)
library(shiny)   # Added this
library(ggplot2) # Added this for your barplot

# Load data
#fogos_2024 <- readRDS("fogos_2024.rds")
```

## Overview: The 2024 Fire Season

This presentation analyzes the spatial and temporal distribution of wildfires across Portugal using interactive data visualization. Core Objectives

```         
Identify Peaks: pin-point periods of high fire frequency.

Impact Assessment: Analyze the scale of burned areas (ha).

Interactive Exploration: Utilize zooming and tooltips for granular data inspection.
```

Data Summary

```         
Temporal Scope: January 1 â€“ December 31, 2024.

Key Variables: Start date (DHInicio), Total Burned Area (AreaTotal), and GPS Coordinates.
```

## Inputs and Outputs

```{r Data Processing, include=TRUE}
# Data processing

# Load data
fogos_2024 <- readRDS("fogos_2024.rds")
fires_daily <- fogos_2024 %>%
        mutate(Date = as.Date(DHInicio)) %>%
        group_by(Date, Distrito) %>%
        summarise(
                DNRF = n(),                               # Daily Number of Recorded Fires
                DBA  = sum(AreaTotal, na.rm = TRUE),      # Daily Burned Area
                FWI  = mean(fwi, na.rm = TRUE),
                .groups = "drop"
        ) %>%
        mutate(
                # 1. Create numeric floor values first for logic
                dnrf_low = floor(DNRF / 10) * 10,
                fwi_low  = floor(FWI / 10) * 10,
                
                # 2. Create the labels in [xx-xx[ format
                DNRF_class = paste0("[", dnrf_low, "-", dnrf_low + 10, "["),
                FWI_class  = paste0("[", fwi_low, "-", fwi_low + 10, "[")
        ) %>%
        # Clean up temporary helper columns
        select(-dnrf_low, -fwi_low)

```

##Interactive Explorer: Top Days

```{r Data Explorer, include=TRUE}
sidebarLayout(
  sidebarPanel(
    sliderInput("dba_range", "Burned Area (DBA):", 
                min = 0, max = max(fires_daily$DBA), value = c(0, max(fires_daily$DBA)), step = 0.1),
    textInput("top_n", "Number of top days:", value = "5"),
    radioButtons("dnrf_class_select", "DNRF Class:",
                 choices = sort(unique(fires_daily$DNRF_class))),
    selectInput("fwi_class_select", "FWI Class:",
                choices = c("All", sort(unique(fires_daily$FWI_class))), selected = "All"),
    checkboxGroupInput("distrito_check", "Distrito:",
                       choices = sort(unique(fires_daily$Distrito)),
                       selected = unique(fires_daily$Distrito)[1:3]),
    style = "font-size: 0.8em; overflow-y: scroll; max-height: 400px;"
  ),
  
  mainPanel(
    plotOutput("barplot", height = "300px"),
    tableOutput("top_days")
  )
)

# Reactive Logic
top_data <- reactive({
  req(input$dba_range, input$dnrf_class_select, input$distrito_check)
  n <- as.numeric(input$top_n)
  if (is.na(n) || n < 1) n <- 1
  
  data <- fires_daily %>%
    filter(
      DBA >= input$dba_range[1],
      DBA <= input$dba_range[2],
      DNRF_class == input$dnrf_class_select,
      Distrito %in% input$distrito_check
    )
  
  if (!is.null(input$fwi_class_select) && input$fwi_class_select != "All") {
    data <- data %>% filter(FWI_class == input$fwi_class_select)
  }
  
  data %>% arrange(desc(DBA)) %>% slice_head(n = n)
})

output$barplot <- renderPlot({
  req(top_data(), nrow(top_data()) > 0)
  ggplot(top_data(), aes(x = reorder(as.character(Date), DBA), y = DBA)) +
    geom_col(fill = "firebrick") +
    coord_flip() +
    labs(x = "Date", y = "Burned Area (ha)", title = "Highest Impact Days") +
    theme_minimal()
})

output$top_days <- renderTable({
  req(top_data())
  top_data() %>% select(Date, Distrito, DNRF, DBA, FWI)
})


server <- function(input, output) {
    
    top_data <- reactive({
        # 1. Ensure inputs are available before running the rest of the code
        req(input$dba_range, input$dnrf_class_select, input$distrito_check)
        
        # Validate Top N input
        n <- as.numeric(input$top_n)
        if (is.na(n) || n < 1) n <- 1
        
        data <- fires_daily %>%
            filter(
                DBA >= input$dba_range[1],
                DBA <= input$dba_range[2],
                DNRF_class == (input$dnrf_class_select),
                Distrito %in% input$distrito_check
            )
        
        # 2. Fix the "if" error by checking if input$fwi_class_select exists
        if (!is.null(input$fwi_class_select)) {
            if (input$fwi_class_select != "All") {
                data <- data %>% filter(FWI_class == input$fwi_class_select)
            }
        }
        
        data %>%
            arrange(desc(DBA)) %>%
            slice_head(n = n)
    })
    
    output$top_days <- renderTable({
        req(top_data()) # Only render if data exists
        top_data()
    })
    
    output$barplot <- renderPlot({
        # 3. req() ensures the plot doesn't try to draw with 0 rows
        req(top_data(), nrow(top_data()) > 0) 
        
        ggplot(top_data(), aes(x = reorder(as.character(Date), DBA), y = DBA)) +
            geom_col(fill = "firebrick") +
            coord_flip() +
            labs(x = "Date", y = "Burned Area", title = "Top Days") +
            theme_minimal()
    })
}


```

## Conclusion & Insights

```         
Seasonality: The data reveals a clear correlation between rising summer temperatures and fire frequency.

Intensity: While most days record low burned areas, a few "extreme" days account for the majority of the annual total.

Next Steps: Integration of meteorological data (IPMA) to model fire risk based on humidity and wind speed
```
